# Models pour le syst√®me de professions et progression
from pydantic import BaseModel, EmailStr, Field
from typing import List, Dict, Optional, Any
from datetime import datetime, timezone
import uuid

# User models
class User(BaseModel):
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    email: EmailStr
    name: Optional[str] = None
    role: str = "user"
    settings: Optional[Dict] = {}
    profession_slug: Optional[str] = None
    profession_label: Optional[str] = None
    profession_icon: Optional[str] = None
    created_at: datetime = Field(default_factory=lambda: datetime.now(timezone.utc))
    has_paid: bool = False
    xp_total: int = 0
    level_number: int = 1

class HabitLog(BaseModel):
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    user_id: str
    date: datetime
    water_ml: float = 0
    sleep_h: float = 0
    nutrition_score_0_100: int = 0
    activity_min: float = 0
    serenity_min: float = 0
    mood_1_10: int = 5
    stress_0_10: int = 5
    notes: Optional[str] = None

class Quest(BaseModel):
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    title: str
    description: str
    type: str  # daily, weekly, special
    points_reward: int
    badge_id: Optional[str] = None
    branch: Optional[str] = None  # stress, sleep, hydration, strength, resilience
    is_global: bool = True
    is_active: bool = True

class UserQuest(BaseModel):
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    user_id: str
    quest_id: str
    date_assigned: datetime
    status: str = "todo"  # todo, in_progress, done
    completed_at: Optional[datetime] = None

class Badge(BaseModel):
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    code: str
    label: str
    description: str
    icon: str

class UserBadge(BaseModel):
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    user_id: str
    badge_id: str
    earned_at: datetime = Field(default_factory=lambda: datetime.now(timezone.utc))

class Quote(BaseModel):
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    text: str
    author: Optional[str] = None

class PaymentTransaction(BaseModel):
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    session_id: str
    user_email: str
    amount: float
    currency: str = "EUR"
    status: str = "pending"
    payment_status: str = "pending"
    metadata: Optional[Dict] = {}
    created_at: datetime = Field(default_factory=lambda: datetime.now(timezone.utc))

# Profession models

class Profession(BaseModel):
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    label: str
    slug: str
    icon: str
    order_index: int = 100
    is_active: bool = True
    recommended_quests: List[Dict] = []
    progression_tree: List[Dict] = []

class ProgressionMetier(BaseModel):
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    profession_slug: str
    niveau: int
    titre: str
    icon: str
    objectif: str
    reward: str
    order_index: int

class UserProgression(BaseModel):
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    user_id: str
    profession_slug: str
    niveau_actuel: int = 1
    xp_total: int = 0
    niveaux_completes: List[int] = []
    created_at: datetime = Field(default_factory=lambda: datetime.now(timezone.utc))
    updated_at: datetime = Field(default_factory=lambda: datetime.now(timezone.utc))

class ProfessionQuest(BaseModel):
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    profession_slug: str
    title: str
    description: str
    points_reward: int
    type: str  # daily, weekly
    branch: Optional[str] = None
    is_active: bool = True

# Donn√©es de seed pour les professions
PROFESSIONS_SEED = [
    {
        "label": "Infirmier¬∑√®re",
        "slug": "infirmier",
        "icon": "ü©∫",
        "order_index": 1,
        "recommended_quests": [
            {"title": "Hydratation 2L au service", "description": "Boire 2L d'eau pendant votre garde", "points_reward": 10, "type": "daily"},
            {"title": "3 pauses respiration pendant les gardes", "description": "Prendre 3 pauses de 5 min de respiration", "points_reward": 30, "type": "weekly"}
        ]
    },
    {
        "label": "Aide-soignant¬∑e", 
        "slug": "aide_soignant",
        "icon": "‚ù§Ô∏è",
        "order_index": 2,
        "recommended_quests": [
            {"title": "S'√©tirer 5 min apr√®s chaque rel√®ve", "description": "√âtirements courts apr√®s changement d'√©quipe", "points_reward": 10, "type": "daily"},
            {"title": "Tenir 5 jours avec 7h de sommeil minimum", "description": "Maintenir un sommeil r√©parateur", "points_reward": 30, "type": "weekly"}
        ]
    },
    {
        "label": "Kin√©sith√©rapeute",
        "slug": "kine", 
        "icon": "üèãÔ∏è",
        "order_index": 3,
        "recommended_quests": [
            {"title": "3 exercices de mobilit√© personnelle", "description": "Travailler √©paules, hanches, dos", "points_reward": 15, "type": "daily"},
            {"title": "5 s√©ances d'auto-renforcement", "description": "Renforcement musculaire 10 min", "points_reward": 40, "type": "weekly"}
        ]
    },
    {
        "label": "M√©decin",
        "slug": "medecin",
        "icon": "‚öïÔ∏è", 
        "order_index": 4,
        "recommended_quests": [
            {"title": "Pause 5 min hors √©cran entre consultations", "description": "D√©connexion num√©rique r√©guli√®re", "points_reward": 10, "type": "daily"},
            {"title": "Limiter les caf√©s sucr√©s pendant 3 jours", "description": "R√©duire le sucre ajout√©", "points_reward": 30, "type": "weekly"}
        ]
    },
    {
        "label": "Sage-femme",
        "slug": "sage_femme",
        "icon": "üë∂",
        "order_index": 5,
        "recommended_quests": [
            {"title": "10 respirations profondes apr√®s chaque accouchement", "description": "R√©cup√©ration post-intervention", "points_reward": 10, "type": "daily"},
            {"title": "3 pauses d√©tente 10 min dans la semaine", "description": "Moments de s√©r√©nit√© programm√©s", "points_reward": 30, "type": "weekly"}
        ]
    },
    {
        "label": "Ambulancier¬∑√®re",
        "slug": "ambulancier",
        "icon": "üöë",
        "order_index": 6,
        "recommended_quests": [
            {"title": "Respiration guid√©e 5 min apr√®s intervention", "description": "R√©cup√©ration post-urgence", "points_reward": 10, "type": "daily"},
            {"title": "3 s√©ances d'√©tirement dos/jambes", "description": "Entretien postural", "points_reward": 30, "type": "weekly"}
        ]
    },
    {
        "label": "Ergoth√©rapeute",
        "slug": "ergo",
        "icon": "‚úã",
        "order_index": 7,
        "recommended_quests": [
            {"title": "Prendre 5 min pour une activit√© manuelle", "description": "Dessin, √©criture cr√©ative", "points_reward": 10, "type": "daily"},
            {"title": "3 jours de suite avec ‚â•7h sommeil", "description": "R√©gularit√© du sommeil", "points_reward": 30, "type": "weekly"}
        ]
    },
    {
        "label": "Psychologue",
        "slug": "psy",
        "icon": "üß†",
        "order_index": 8,
        "recommended_quests": [
            {"title": "√âcrire une pens√©e positive apr√®s chaque s√©ance", "description": "Journal de gratitude professionnel", "points_reward": 10, "type": "daily"},
            {"title": "2 jours de m√©ditation 10 min", "description": "Pratique m√©ditative r√©guli√®re", "points_reward": 30, "type": "weekly"}
        ]
    },
    {
        "label": "Manipulateur¬∑trice radio",
        "slug": "manip_radio",
        "icon": "üì∏",
        "order_index": 9,
        "recommended_quests": [
            {"title": "5 min √©tirements poignets/√©paules", "description": "Pr√©vention TMS", "points_reward": 10, "type": "daily"},
            {"title": "Marcher 20 min 3x/semaine", "description": "Activit√© cardiovasculaire douce", "points_reward": 30, "type": "weekly"}
        ]
    },
    {
        "label": "ASH (Agent de Service Hospitalier)",
        "slug": "ash",
        "icon": "üßπ",
        "order_index": 10,
        "recommended_quests": [
            {"title": "Pause respiration 3 min entre deux t√¢ches", "description": "Micro-r√©cup√©ration active", "points_reward": 10, "type": "daily"},
            {"title": "Hydratation ‚â• 1,5L/jour sur 5 jours", "description": "Maintien hydratation optimale", "points_reward": 30, "type": "weekly"}
        ]
    },
    {
        "label": "√âtudiant¬∑e en soins infirmiers",
        "slug": "etudiant",
        "icon": "üìö",
        "order_index": 11,
        "recommended_quests": [
            {"title": "R√©vision rapide 10 min", "description": "Flashcards ou notes de cours", "points_reward": 10, "type": "daily"},
            {"title": "Sommeil ‚â• 7h sur 4 nuits", "description": "R√©cup√©ration √©tudiante", "points_reward": 30, "type": "weekly"}
        ]
    },
    {
        "label": "Auxiliaire de pu√©riculture",
        "slug": "aux_puer",
        "icon": "üçº",
        "order_index": 12,
        "recommended_quests": [
            {"title": "Hydratation r√©guli√®re (1 verre toutes les 2h)", "description": "Rythme hydratation structur√©", "points_reward": 10, "type": "daily"},
            {"title": "2 s√©ances relaxation 10 min", "description": "Techniques de d√©tente", "points_reward": 30, "type": "weekly"}
        ]
    },
    {
        "label": "Cadre de sant√©",
        "slug": "cadre",
        "icon": "üóÇÔ∏è",
        "order_index": 13,
        "recommended_quests": [
            {"title": "Check bien-√™tre : humeur/stress en d√©but de journ√©e", "description": "Auto-√©valuation matinale", "points_reward": 10, "type": "daily"},
            {"title": "Bloquer 30 min dans la semaine pour soi", "description": "Temps personnel programm√©", "points_reward": 30, "type": "weekly"}
        ]
    },
    {
        "label": "Ost√©opathe",
        "slug": "osteo",
        "icon": "ü§≤",
        "order_index": 14,
        "recommended_quests": [
            {"title": "Auto-√©tirement 5 min apr√®s chaque patient", "description": "Maintenance corporelle continue", "points_reward": 10, "type": "daily"},
            {"title": "3 s√©ances renfo musculaire 15 min", "description": "Renforcement pr√©ventif", "points_reward": 40, "type": "weekly"}
        ]
    },
    {
        "label": "Nutritionniste / Di√©t√©ticien¬∑ne",
        "slug": "nutri",
        "icon": "ü•ó",
        "order_index": 15,
        "recommended_quests": [
            {"title": "Prendre un repas √©quilibr√© sans √©cran", "description": "Alimentation consciente", "points_reward": 10, "type": "daily"},
            {"title": "Pr√©parer 3 repas maison dans la semaine", "description": "Cuisine th√©rapeutique", "points_reward": 30, "type": "weekly"}
        ]
    }
]

# Donn√©es de progression par m√©tier
PROGRESSION_SEED = [
    # INFIRMIER
    {"profession_slug": "infirmier", "niveau": 1, "titre": "Gardien de l'hydratation", "icon": "üíß", "objectif": "2L d'eau/jour √ó 5 jours", "reward": "+50 XP", "order_index": 1},
    {"profession_slug": "infirmier", "niveau": 2, "titre": "Veilleur¬∑se du sommeil", "icon": "üí§", "objectif": "‚â•7h sur 5 nuits", "reward": "+70 XP", "order_index": 2},
    {"profession_slug": "infirmier", "niveau": 3, "titre": "Champion¬∑ne des pauses", "icon": "üå¨", "objectif": "10 respirations guid√©es", "reward": "+100 XP", "order_index": 3},
    {"profession_slug": "infirmier", "niveau": 4, "titre": "Force tranquille", "icon": "ü™∑", "objectif": "3 semaines ‚â•70% habitudes", "reward": "+150 XP", "order_index": 4},
    {"profession_slug": "infirmier", "niveau": 5, "titre": "Mod√®le de constance", "icon": "‚≠ê", "objectif": "30 jours de suivi", "reward": "+200 XP + Badge ‚≠ê", "order_index": 5},
    
    # AIDE-SOIGNANT
    {"profession_slug": "aide_soignant", "niveau": 1, "titre": "Soulagement rapide", "icon": "ü§∏", "objectif": "5 √©tirements courts", "reward": "+50 XP", "order_index": 1},
    {"profession_slug": "aide_soignant", "niveau": 2, "titre": "Soutien vital", "icon": "üí§", "objectif": "5 jours ‚â•7h sommeil", "reward": "+70 XP", "order_index": 2},
    {"profession_slug": "aide_soignant", "niveau": 3, "titre": "√ânergie au service", "icon": "üíß", "objectif": "7 jours ‚â•80% hydratation", "reward": "+100 XP", "order_index": 3},
    {"profession_slug": "aide_soignant", "niveau": 4, "titre": "Endurance douce", "icon": "üèÉ", "objectif": "3 semaines ‚â•70% activit√©", "reward": "+150 XP", "order_index": 4},
    {"profession_slug": "aide_soignant", "niveau": 5, "titre": "Pilier du service", "icon": "üèÖ", "objectif": "30 jours constance", "reward": "+200 XP + Badge üèÖ", "order_index": 5},
    
    # KINE
    {"profession_slug": "kine", "niveau": 1, "titre": "Mobilit√© active", "icon": "ü¶µ", "objectif": "3 exercices mobilit√© √ó 5 jours", "reward": "+50 XP", "order_index": 1},
    {"profession_slug": "kine", "niveau": 2, "titre": "√âquilibre postural", "icon": "ü™ë", "objectif": "3 s√©ances renfo en 1 semaine", "reward": "+70 XP", "order_index": 2},
    {"profession_slug": "kine", "niveau": 3, "titre": "Expert du mouvement", "icon": "‚ö°", "objectif": "10 jours ‚â•80% activit√©", "reward": "+100 XP", "order_index": 3},
    {"profession_slug": "kine", "niveau": 4, "titre": "Sant√© incarn√©e", "icon": "ü•ó", "objectif": "4 semaines ‚â•70% nutrition+activit√©", "reward": "+150 XP", "order_index": 4},
    {"profession_slug": "kine", "niveau": 5, "titre": "Ma√Ætre kin√©", "icon": "üèÜ", "objectif": "40 jours suivis", "reward": "+200 XP + Badge üèÜ", "order_index": 5},

    # MEDECIN
    {"profession_slug": "medecin", "niveau": 1, "titre": "Pause bien m√©rit√©e", "icon": "‚òï", "objectif": "5 min hors √©cran entre consultations", "reward": "+50 XP", "order_index": 1},
    {"profession_slug": "medecin", "niveau": 2, "titre": "D√©tox caf√©in√©e", "icon": "ü•§", "objectif": "Limiter caf√©s sucr√©s pendant 3 jours", "reward": "+70 XP", "order_index": 2},
    {"profession_slug": "medecin", "niveau": 3, "titre": "R√©cup rapide", "icon": "üßò", "objectif": "Activit√© douce ‚â•70% sur 7 jours", "reward": "+100 XP", "order_index": 3},
    {"profession_slug": "medecin", "niveau": 4, "titre": "Calme du praticien", "icon": "ü™∑", "objectif": "4 semaines ‚â•70% s√©r√©nit√©", "reward": "+150 XP", "order_index": 4},
    {"profession_slug": "medecin", "niveau": 5, "titre": "Force soignante", "icon": "ü©∫", "objectif": "30 jours constance", "reward": "+200 XP + Badge ü©∫", "order_index": 5},

    # SAGE-FEMME
    {"profession_slug": "sage_femme", "niveau": 1, "titre": "Soutien maternel", "icon": "üë∂", "objectif": "10 min respiration consciente", "reward": "+50 XP", "order_index": 1},
    {"profession_slug": "sage_femme", "niveau": 2, "titre": "Douceur nocturne", "icon": "üåô", "objectif": "‚â•7h de sommeil √ó 5 nuits", "reward": "+70 XP", "order_index": 2},
    {"profession_slug": "sage_femme", "niveau": 3, "titre": "Accompagnante sereine", "icon": "ü§±", "objectif": "7 jours ‚â•70% hydratation", "reward": "+100 XP", "order_index": 3},
    {"profession_slug": "sage_femme", "niveau": 4, "titre": "Pilier du calme", "icon": "ü™∑", "objectif": "3 semaines constance bien-√™tre", "reward": "+150 XP", "order_index": 4},
    {"profession_slug": "sage_femme", "niveau": 5, "titre": "Mod√®le inspirant", "icon": "üë©‚Äçüëß", "objectif": "30 jours constance", "reward": "+200 XP + Badge üíé", "order_index": 5},

    # AMBULANCIER
    {"profession_slug": "ambulancier", "niveau": 1, "titre": "R√©activit√© saine", "icon": "üöë", "objectif": "Hydratation r√©guli√®re √ó 5 jours", "reward": "+50 XP", "order_index": 1},
    {"profession_slug": "ambulancier", "niveau": 2, "titre": "Pause √©clair", "icon": "‚ö°", "objectif": "3 pauses respiration", "reward": "+70 XP", "order_index": 2},
    {"profession_slug": "ambulancier", "niveau": 3, "titre": "Force mobile", "icon": "üí™", "objectif": "7 jours ‚â•80% activit√© douce", "reward": "+100 XP", "order_index": 3},
    {"profession_slug": "ambulancier", "niveau": 4, "titre": "Calme en urgence", "icon": "üßò", "objectif": "3 semaines s√©r√©nit√©", "reward": "+150 XP", "order_index": 4},
    {"profession_slug": "ambulancier", "niveau": 5, "titre": "Pilier des routes", "icon": "üèÖ", "objectif": "30 jours constance", "reward": "+200 XP + Badge üöë", "order_index": 5},

    # PSYCHOLOGUE
    {"profession_slug": "psy", "niveau": 1, "titre": "√âcoute int√©rieure", "icon": "üß†", "objectif": "5 min m√©ditation/jour", "reward": "+50 XP", "order_index": 1},
    {"profession_slug": "psy", "niveau": 2, "titre": "S√©r√©nit√© active", "icon": "üåø", "objectif": "‚â•7h sommeil √ó 5 nuits", "reward": "+70 XP", "order_index": 2},
    {"profession_slug": "psy", "niveau": 3, "titre": "Clart√© d'esprit", "icon": "‚ú®", "objectif": "7 jours ‚â•70% hydratation", "reward": "+100 XP", "order_index": 3},
    {"profession_slug": "psy", "niveau": 4, "titre": "Pr√©sence calme", "icon": "ü™∑", "objectif": "3 semaines ‚â•70% habitudes", "reward": "+150 XP", "order_index": 4},
    {"profession_slug": "psy", "niveau": 5, "titre": "Ma√Ætre de l'√©quilibre", "icon": "üíé", "objectif": "30 jours constance", "reward": "+200 XP + Badge üß†", "order_index": 5}
]